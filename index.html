<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:; script-src 'self' https://www.gstatic.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com;">

    <title>‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ ‡§ï‡§≤‡•ç‡§™‡§¶‡•ç‡§∞‡•Ç‡§Æ</title>
    
    <script src="filelist.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        /* --- 1. GLOBAL SETTINGS --- */
        :root { --glass: rgba(255,255,255,0.2); --text: #000; --overlay: rgba(255,255,255,0.5); }
        body.dark-mode { --glass: rgba(0,0,0,0.6); --text: #fff; --overlay: rgba(0,0,0,0.7); }
        
        body {
            margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; 
            color: var(--text); 
            background-color: #333; 
            background-size: cover; background-position: center; 
            transition: 0.5s;
            -webkit-user-select: none; user-select: none; /* ‡§ï‡•â‡§™‡•Ä ‡§™‡•á‡§∏‡•ç‡§ü ‡§¨‡§Ç‡§¶ */
        }
        
        /* ‡§°‡§æ‡§Ø‡§®‡•Ö‡§Æ‡§ø‡§ï ‡§¨‡•Ö‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
        body.state-login { background-image: url('login_bg.png'); }
        body.state-day { background-image: url('day_bg.png'); }
        body.state-night { background-image: url('night_bg.png'); }

        #login-screen, #library-screen, #reader-screen { position: absolute; width: 100%; height: 100%; }
        #library-screen, #reader-screen { display: none; }

        /* --- 2. LOGIN UI --- */
        #login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.4); }
        
        .glass-card { 
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 20px; border-radius: 20px; text-align: center; 
            border: 1px solid rgba(255,255,255,0.3); 
            width: 85%; max-width: 350px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: white;
            animation: fadeIn 1s ease;
        }

        .app-title { font-size: 26px; font-weight: bold; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* ‡§ì‡§µ‡•Ä ‡§¨‡•â‡§ï‡•ç‡§∏ */
        .shlok-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px; border-radius: 10px;
            font-size: 14px; font-style: italic; line-height: 1.6;
            margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);
            color: #ffeb3b; /* ‡§•‡•ã‡§°‡§æ ‡§™‡§ø‡§µ‡§≥‡§∏‡§∞ ‡§∞‡§Ç‡§ó ‡§ì‡§µ‡•Ä‡§∏‡§æ‡§†‡•Ä */
        }

        input { 
            padding: 12px; border-radius: 30px; border: none; text-align: center; 
            width: 90%; margin-bottom: 15px; font-size: 18px; outline:none; 
            background: rgba(255,255,255,0.9); color: black;
        }
        
        .btn { 
            padding: 12px; border-radius: 30px; border: none; 
            background: white; color: black; font-weight: bold; width: 100%; 
            cursor: pointer; font-size: 16px; transition: 0.3s;
        }
        .btn:active { transform: scale(0.95); }

        .footer {
            position: absolute; bottom: 20px;
            color: rgba(255,255,255,0.9);
            font-size: 14px; font-weight: 500;
            text-shadow: 0 1px 3px black;
            letter-spacing: 1px;
        }

        /* --- 3. LIBRARY UI --- */
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: var(--glass); backdrop-filter: blur(10px); }
        .scroll-area { height: 85%; overflow-y: auto; padding: 15px; }
        
        .book-card { background: var(--glass); border-radius: 15px; overflow: hidden; margin-bottom: 15px; transition: 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        
        /* Grid View */
        .grid-view { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-view .book-card { height: 220px; display: flex; } 
        .grid-view .thumb { width: 100%; height: 100%; object-fit: fill; }
        .grid-view .title { display: none; }

        /* List View */
        .list-view { display: flex; flex-direction: column; }
        .list-view .book-card { height: 80px; display: flex; flex-direction: row; align-items: center; padding: 10px; }
        .list-view .thumb { width: 60px; height: 80px; object-fit: cover; margin-right: 15px; border-radius: 5px; }
        .list-view .title { font-weight: bold; font-size: 16px; }

        /* --- 4. READER UI --- */
        iframe { width: 100%; height: 93%; border: none; background: white; }
        .nav { height: 7%; background: #222; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="state-login">

    <div id="login-screen">
        <div class="glass-card">
            <div class="app-title">‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ ‡§ï‡§≤‡•ç‡§™‡§¶‡•ç‡§∞‡•Ç‡§Æ</div>
            
            <div class="shlok-box">
                "‡§∂‡•ç‡§∞‡•Ä‡§ï‡•É‡§∑‡•ç‡§£‡§∞‡§æ‡§µ‡•ã ‡§Æ‡•ç‡§π‡§£‡•á ‡§â‡§¶‡•ç‡§ß‡§µ‡§¶‡•á‡§µ‡§æ : ‡§π‡§æ ‡§ú‡•ç‡§û‡§æ‡§®‡§∞‡§§‡•ç‡§®‡§æ‡§ö‡§æ ‡§†‡•á‡§µ‡§æ :<br>
                ‡§≠‡§≤‡•á‡§§‡§Ø‡§æ ‡§π‡§æ‡§§‡•Ä‡§Ç ‡§®‡•á‡§¶‡§æ‡§µ‡§æ : ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•á‡§Ç‡§µ‡•Ä‡§£ ‡•§‡•§<br><br>
                ‡§π‡•á ‡§ú‡•ç‡§û‡§æ‡§®‡§∏‡•Å‡§ß‡§æ ‡§ó‡•ã‡§Æ‡§ü‡•Ä : ‡§ú‡•á ‡§™‡§æ‡§® ‡§ï‡§∞‡•Ä‡§§‡§ø ‡§ï‡§∞‡•ç‡§£‡§™‡•Å‡§ü‡•Ä‡§Ç :<br>
                ‡§§‡§Ø‡§æ‡§Ç ‡§ï‡§π‡§ø‡§Ç ‡§®‡§æ‡§π‡§ø‡§Ç ‡§ï‡§æ‡§Æ‡§æ‡§†‡•Ä : ‡§ú‡§®‡•ç‡§Æ‡§Æ‡§∞‡§£‡§æ‡§ö‡•Ä ‡•§‡•§"
            </div>

            <input type="tel" id="pin" placeholder="PIN ‡§ü‡§æ‡§ï‡§æ" maxlength="8">
            <button class="btn" onclick="performLogin()">‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§ï‡§∞‡§æ</button>
        </div>

        <div class="footer">|| ‡§∂‡•ç‡§∞‡•Ä ‡§¶‡•á‡§µ‡§¶‡§§‡•ç‡§§ ‡§Ü‡§∂‡•ç‡§∞‡§Æ, ‡§ú‡§æ‡§ß‡§µ‡§µ‡§æ‡§°‡•Ä ||</div>
    </div>

    <div id="library-screen">
        <div class="header">
            <strong style="font-size:20px;">‡§ó‡•ç‡§∞‡§Ç‡§•‡§æ‡§≤‡§Ø</strong>
            <div>
                <button class="btn" style="width:auto; padding:8px 15px;" onclick="toggleTheme()">üåó</button>
                <button class="btn" style="width:auto; padding:8px 15px;" onclick="toggleView()">‚äû</button>
            </div>
        </div>
        <div class="scroll-area">
            <div id="book-container" class="grid-view"></div>
        </div>
    </div>

    <div id="reader-screen">
        <div class="nav">
            <span onclick="closeBook()" style="font-size:24px; cursor:pointer;">&#10094;</span>
            <span id="read-title">Reading</span>
            <span onclick="closeBook()" style="font-size:24px; cursor:pointer;">&#127968;</span>
        </div>
        <iframe id="frame"></iframe>
    </div>

    <script>
        // --- 1. SETUP ---
        var firebaseConfig = { 
            databaseURL: "https://brahmvidya-app-default-rtdb.asia-southeast1.firebasedatabase.app/" // <--- ‡§§‡•Å‡§Æ‡§ö‡•Ä URL ‡§ü‡§æ‡§ï‡§æ
        }; 
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        var db = firebase.database();
        
        var deviceId = localStorage.getItem('did') || 'USER_' + Math.floor(Math.random()*10000);
        localStorage.setItem('did', deviceId);

        // ‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ (Memory)
        var allowedBooks = JSON.parse(localStorage.getItem('my_allowed_books')) || {};

        // --- 2. LOGIN LOGIC ---
        function performLogin() {
            var pin = document.getElementById('pin').value;
            
            if(pin === "92252320") {
                // UI ‡§¨‡§¶‡§≤‡§æ
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('library-screen').style.display = 'block';
                
                // ‡§•‡•Ä‡§Æ ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ
                var savedTheme = localStorage.getItem('theme') || 'light';
                if(savedTheme === 'dark') document.body.classList.add('dark-mode');
                updateBg();

                // ‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡•á ‡§¶‡§æ‡§ñ‡§µ‡§æ (Local Memory ‡§§‡•Ç‡§®)
                loadBooks();

                // ‡§¨‡•Ö‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§°‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§®‡§µ‡•Ä‡§® ‡§°‡•á‡§ü‡§æ ‡§Ü‡§£‡§æ (Silent Sync)
                syncInBackground();
            } else {
                alert("‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§™‡§ø‡§®!");
            }
        }

        // --- 3. SILENT SYNC ---
        function syncInBackground() {
            if(navigator.onLine) {
                // Admin ‡§≤‡§æ ‡§∏‡§æ‡§Ç‡§ó‡§æ User ‡§Ü‡§≤‡§æ‡§Ø
                db.ref('users/' + deviceId).update({ 
                    last_login: new Date().toISOString(),
                    device_name: "Android User"
                });

                // Admin ‡§≤‡§æ ‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡§æ‡§Ç‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä ‡§™‡§æ‡§†‡§µ‡§æ
                if(typeof autoBookList !== 'undefined') {
                    db.ref('library_catalog').set(autoBookList);
                }

                // ‡§®‡§µ‡•Ä‡§® ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ ‡§Ü‡§π‡•á‡§§ ‡§ï‡§æ ‡§ö‡•á‡§ï ‡§ï‡§∞‡§æ
                db.ref('users/' + deviceId + '/access').once('value', snap => {
                    var newAccess = snap.val();
                    if(newAccess) {
                        localStorage.setItem('my_allowed_books', JSON.stringify(newAccess));
                        allowedBooks = newAccess;
                        loadBooks(); // ‡§Ø‡•Å‡§ú‡§∞‡§≤‡§æ ‡§® ‡§∏‡§æ‡§Ç‡§ó‡§§‡§æ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã‡§à‡§≤
                    }
                });
            }
        }

        // --- 4. RENDER BOOKS ---
        function loadBooks() {
            var container = document.getElementById('book-container');
            container.innerHTML = "";
            
            if(typeof autoBookList === 'undefined') return;
            var count = 0;

            autoBookList.forEach(book => {
                if (allowedBooks[book.name]) {
                    count++;
                    var div = document.createElement('div');
                    div.className = "book-card";
                    
                    var img = book.image ? `<img src="${book.image}" class="thumb">` : '';
                    div.innerHTML = `${img}<div class="title">${book.name}</div>`;
                    
                    div.onclick = () => openReader(book.file, book.name);
                    container.appendChild(div);
                }
            });

            if(count === 0) {
                container.innerHTML = `<p style="text-align:center; padding-top:50px; opacity:0.8; color:white;">‡§Ö‡§ú‡•Ç‡§® ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§ó‡•ç‡§∞‡§Ç‡§• ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.<br><small>‡§ï‡•É‡§™‡§Ø‡§æ ‡•≤‡§°‡§Æ‡§ø‡§®‡§∂‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§∏‡§æ‡§ß‡§æ.</small></p>`;
            }
        }

        function openReader(file, title) {
            document.getElementById('library-screen').style.display = 'none';
            document.getElementById('reader-screen').style.display = 'block';
            document.getElementById('frame').src = file;
            document.getElementById('read-title').innerText = title;
        }

        // --- 5. UI HELPERS ---
        function toggleTheme() { 
            document.body.classList.toggle('dark-mode'); 
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            updateBg(); 
        }
        function toggleView() { 
            var c = document.getElementById('book-container');
            c.classList.toggle('grid-view'); c.classList.toggle('list-view');
        }
        function updateBg() {
            var mode = document.body.classList.contains('dark-mode') ? 'night' : 'day';
            if(document.getElementById('login-screen').style.display !== 'none') mode = 'login';
            
            document.body.className = ''; // Reset
            if(mode === 'night') document.body.classList.add('dark-mode');
            document.body.classList.add('state-' + mode);
        }
        function closeBook() {
            document.getElementById('reader-screen').style.display = 'none';
            document.getElementById('library-screen').style.display = 'block';
            document.getElementById('frame').src = "";
        }
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>
