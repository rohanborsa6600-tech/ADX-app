name: Brahmavidya Guaranteed Build

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with: { node-version: 16 }
      - run: npm install -g cordova
      - uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17' }

      # --- STEP 1: рдкреНрд░реЛрдЬреЗрдХреНрдЯ рддрдпрд╛рд░ рдХрд░рдгреЗ ---
      - name: Create Project
        run: |
          cordova create myapp com.brahmavidya.ovi "Brahmavidya"
          cd myapp
          cordova plugin add cordova-plugin-statusbar
          cordova plugin add cordova-plugin-network-information
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-whitelist
          cordova platform add android
          
          # рдмреЗрд╕рд┐рдХ рд╕реЗрдЯрд┐рдВрдЧреНрд╕
          sed -i '/<widget/a <preference name="Fullscreen" value="true" />' config.xml
          sed -i '/<widget/a <preference name="Orientation" value="portrait" />' config.xml
          sed -i '/<widget/a <preference name="BackgroundColor" value="0xff000000" />' config.xml
          cd ..

      # --- STEP 2: рддреБрдордЪреЗ рдлреЛрдЯреЛ рддрдкрд╛рд╕рдгреЗ рдЖрдгрд┐ "Safe Mode" рд╡рд╛рдкрд░рдгреЗ ---
      - name: Verify and Copy Assets
        run: |
          echo "Checking uploaded files..."
          
          # рдПрдХ рдлрдВрдХреНрд╢рди рдЬреЗ рдлрд╛рдИрд▓ рдЪреЗрдХ рдХрд░реЗрд▓. рдЬрд░ рдлрд╛рдИрд▓ рдЦрд░рд╛рдм рдЕрд╕реЗрд▓ рддрд░ рдбрдореА рдлрд╛рдИрд▓ рд╡рд╛рдкрд░реЗрд▓.
          check_and_copy() {
            FILE=$1
            DEST=$2
            # рдЬрд░ рдлрд╛рдИрд▓ рдирд╕реЗрд▓ рдХрд┐рдВрд╡рд╛ рд╕рд╛рдИрдЬ 0 рдЕрд╕реЗрд▓ (Empty File)
            if [ ! -s "$FILE" ]; then
              echo "тЪая╕П WARNING: $FILE is missing or empty! Using backup."
              # рдПрдХ рд╕реЗрдл рдбрдореА рдлреЛрдЯреЛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдгреЗ (рд╡рд┐рдХрд┐рдкреАрдбрд┐рдпрд╛рд╡рд░реВрди)
              wget -O "myapp/www/$DEST" "https://upload.wikimedia.org/wikipedia/commons/4/47/PNG_transparency_demonstration_1.png"
            else
              echo "тЬЕ SUCCESS: $FILE is valid. Using it."
              cp "$FILE" "myapp/www/$DEST"
            fi
          }

          # рдлрд╛рдИрд▓реНрд╕ рдХреНрд▓рд┐рдЕрд░ рдХрд░рдгреЗ
          rm myapp/www/index.html myapp/www/css/index.css myapp/www/js/index.js
          
          # HTML/JS рдХреЙрдкреА рдХрд░рдгреЗ
          cp index.html myapp/www/
          cp *.html myapp/www/ || true
          cp *.css myapp/www/ || true
          cp *.js myapp/www/ || true
          
          # --- ЁЯФе рдЗрдереЗ рдЦрд░реА рдЬрд╛рджреВ рдЖрд╣реЗ (Smart Copy) ЁЯФе ---
          # рд╣реЗ рддреБрдордЪреЗ рдлреЛрдЯреЛ рддрдкрд╛рд╕реЗрд▓, рдЦрд░рд╛рдм рдЕрд╕рддреАрд▓ рддрд░ рдмрджрд▓реВрди рдЯрд╛рдХреЗрд▓, рдкрдг Error рджреЗрдгрд╛рд░ рдирд╛рд╣реА.
          
          check_and_copy "logo.png" "logo.png"
          check_and_copy "login_bg.png" "login_bg.png"
          check_and_copy "cover.jpg" "cover.jpg"
          check_and_copy "photo1.jpg" "photo1.jpg"
          check_and_copy "photo2.jpg" "photo2.jpg"
          
          # рдЖрдпрдХреЙрди рд╕реЗрдЯ рдХрд░рдгреЗ (рдЖрддрд╛ logo.png рддрд┐рдереЗ рдЕрд╕рдгрд╛рд░рдЪ)
          cd myapp
          sed -i '/<widget/a <icon src="www/logo.png" />' config.xml
          cd ..
          
          # File List рдмрдирд╡рдгреЗ
          cd myapp/www
          echo "var autoBookList = [" > filelist.js
          for f in *.html; do
            if [ "$f" != "index.html" ] && [ "$f" != "admin.html" ]; then
              baseName=$(basename "$f" .html)
              img="cover.jpg"
              if [ -f "$baseName.jpg" ]; then img="$baseName.jpg"; fi
              echo "{ name: '$baseName', file: '$f', image: '$img' }," >> filelist.js
            fi
          done
          echo "];" >> filelist.js
          cd ../..

      # --- STEP 3: APK рдмрд┐рд▓реНрдб рдХрд░рдгреЗ ---
      - name: Build APK
        run: |
          cd myapp
          # рд╣рд╛ рдХрдорд╛рдВрдб рдлреЗрд▓ рдЭрд╛рд▓рд╛ рддрд░реА рдЪрд╛рд▓реЗрд▓, рдкрдг рдЖрдкрдг рддреЛ рдиреАрдЯрдЪ рдЪрд╛рд▓рд╡реВ
          cordova build android --debug
          
      - uses: actions/upload-artifact@v4
        with:
          name: Brahmavidya-APK-Final
          path: myapp/platforms/android/app/build/outputs/apk/debug/app-debug.apk
